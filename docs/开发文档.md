# 分子对接结果优化排序工具开发文档

## 1. 项目概述

本项目是一个用于处理Schrodinger Maestro软件Glide模块SP等级的多个蛋白分子对接结果文件的工具，通过综合各评价指标，对小分子构象进行优度排序。工具支持命令行和图形界面两种操作模式，提供灵活的指标选择和权重调整功能。

## 2. 系统架构

### 2.1 整体架构

项目采用模块化设计，主要分为以下几个部分：

1. **配置模块**：管理配置参数和默认值
2. **数据处理模块**：负责数据的读取、预处理和写入
3. **核心算法模块**：负责评分计算和排序处理
4. **用户界面模块**：提供命令行和图形用户界面
5. **工具模块**：提供日志记录和辅助函数

### 2.2 目录结构

```
项目根目录/
├── src/                      # 源代码目录
│   ├── __init__.py           # 包初始化文件
│   ├── config.py             # 配置文件
│   ├── main.py               # 主程序入口
│   ├── core/                 # 核心算法包
│   │   ├── __init__.py
│   │   ├── metrics.py        # 指标处理模块
│   │   ├── scorer.py         # 评分计算模块
│   │   └── ranker.py         # 排序处理模块
│   ├── data/                 # 数据处理包
│   │   ├── __init__.py
│   │   ├── reader.py         # 数据读取模块
│   │   ├── processor.py      # 数据预处理模块
│   │   └── writer.py         # 数据写入模块
│   ├── ui/                   # 用户界面包
│   │   ├── __init__.py
│   │   ├── cli.py            # 命令行界面模块
│   │   └── gui/              # 图形用户界面包
│   │       ├── __init__.py
│   │       └── main_window.py # 主窗口模块
│   └── utils/                # 工具包
│       ├── __init__.py
│       ├── logger.py         # 日志工具模块
│       └── helpers.py        # 辅助函数模块
├── tests/                    # 测试目录
│   ├── __init__.py
│   ├── run_tests.py          # 测试运行脚本
│   ├── test_reader.py        # 数据读取模块测试
│   ├── test_processor.py     # 数据预处理模块测试
│   ├── test_scorer.py        # 评分计算模块测试
│   ├── test_ranker.py        # 排序处理模块测试
│   └── test_writer.py        # 数据写入模块测试
├── docs/                     # 文档目录
│   ├── 使用说明.md            # 用户使用说明
│   └── 开发文档.md            # 开发文档
├── logs/                     # 日志目录
├── resources/                # 资源目录
├── requirements.txt          # 依赖包列表
└── README.md                 # 项目说明
```

## 3. 模块说明

### 3.1 配置模块 (config.py)

配置模块负责管理程序的配置参数，包括默认配置、指标列表和权重设置等。主要包含以下内容：

- 默认配置字典
- 日志级别映射
- 必选指标列表
- 可选指标列表
- 对接分数相关指标列表
- 能量相关指标列表
- Config类：用于加载和管理配置

### 3.2 数据处理模块

#### 3.2.1 数据读取模块 (reader.py)

数据读取模块负责读取CSV文件并进行初步处理。主要包含以下功能：

- 读取单个CSV文件
- 读取目录中的所有CSV文件
- 获取蛋白质名称列表
- 获取唯一构象标识

#### 3.2.2 数据预处理模块 (processor.py)

数据预处理模块负责数据清洗和标准化。主要包含以下功能：

- 处理特殊值（10000）
- 标准化指标值（min-max或z-score）
- 按蛋白质拆分数据

#### 3.2.3 数据写入模块 (writer.py)

数据写入模块负责将结果输出到Excel文件。主要包含以下功能：

- 写入构象排序结果
- 写入蛋白质排序结果
- 导出原始数据

### 3.3 核心算法模块

#### 3.3.1 指标处理模块 (metrics.py)

指标处理模块负责处理各项评价指标。主要包含以下功能：

- 获取标准化后的指标值
- 计算加权评分
- 计算对接分数相关指数
- 计算能量相关指数
- 计算可选指标评分
- 计算综合评分

#### 3.3.2 评分计算模块 (scorer.py)

评分计算模块负责计算综合评分。主要包含以下功能：

- 计算数据的评分
- 计算每个构象与每个蛋白质的评分

#### 3.3.3 排序处理模块 (ranker.py)

排序处理模块负责对构象和蛋白质进行排序。主要包含以下功能：

- 对构象进行排序
- 对蛋白质进行排序

### 3.4 用户界面模块

#### 3.4.1 命令行界面模块 (cli.py)

命令行界面模块提供命令行操作。主要包含以下功能：

- 解析命令行参数
- 运行数据处理流程

#### 3.4.2 图形用户界面模块 (gui/main_window.py)

图形用户界面模块提供图形操作界面。主要包含以下功能：

- 创建主窗口及各选项卡
- 处理用户交互
- 运行数据处理流程
- 显示处理结果

### 3.5 工具模块

#### 3.5.1 日志工具模块 (logger.py)

日志工具模块负责记录程序运行过程。主要包含以下功能：

- 设置日志记录器
- 获取已配置的日志记录器

#### 3.5.2 辅助函数模块 (helpers.py)

辅助函数模块提供各种通用工具函数。主要包含以下功能：

- 列出目录中的CSV文件
- 从文件路径获取蛋白质名称
- 检查必需列
- 处理特殊值
- 确保目录存在
- 格式化浮点数

## 4. 数据流程

1. **数据读取**：从指定目录读取CSV文件，提取必要的列和数据
2. **数据预处理**：处理特殊值，确保数值列为浮点型
3. **数据标准化**：对各指标进行标准化处理，使不同量纲的指标可比
4. **评分计算**：计算对接分数相关指数、能量相关指数和可选指标评分，合成总对接效果指数
5. **排序处理**：对构象进行排序，找出每个构象最优的蛋白质；对蛋白质进行排序，评估其与小分子构象的匹配程度
6. **结果输出**：将排序结果输出到Excel文件

## 5. 评分算法

评分算法是本工具的核心，主要包括以下步骤：

1. **指标标准化**：
   - min-max标准化：将指标值映射到[0,1]区间
   - z-score标准化：先计算z-score，再通过sigmoid函数映射到(0,1)区间

2. **指标加权**：
   - 对每个指标应用用户设置的权重
   - 计算加权平均值

3. **综合评分计算**：
   - 对接分数相关指数：对接分数和Glide得分的加权平均
   - 能量相关指数：模型能量和总能量的加权平均
   - 可选指标评分：所有选中的可选指标的加权平均
   - 总对接效果指数：对接分数相关指数、能量相关指数和可选指标评分的加权平均

4. **排序规则**：
   - 构象排序：按总对接效果指数升序排序（值越低越优）
   - 蛋白质排序：先按最优构象数量降序排序，相同时按平均总对接效果指数升序排序

## 6. 测试方案

测试采用单元测试方法，主要测试以下模块：

1. **数据读取模块**：测试读取CSV文件和目录的功能
2. **数据预处理模块**：测试数据预处理和标准化功能
3. **评分计算模块**：测试评分计算功能
4. **排序处理模块**：测试构象和蛋白质排序功能
5. **数据写入模块**：测试结果输出功能

运行测试：

```bash
python -m tests.run_tests
```

## 7. 扩展与维护

### 7.1 添加新指标

1. 在`config.py`中的`OPTIONAL_METRICS`列表中添加新指标
2. 如果需要，在`DOCKING_METRICS`或`ENERGY_METRICS`列表中添加新指标
3. 更新`metrics.py`中的评分计算逻辑（如果需要）

### 7.2 修改评分算法

1. 修改`metrics.py`中的`calculate_composite_score`方法
2. 如果需要添加新的标准化方法，修改`processor.py`中的`normalize_metric`方法

### 7.3 添加新的用户界面元素

1. 修改`gui/main_window.py`中的相关方法，添加新的界面元素
2. 添加相应的事件处理函数

## 8. 依赖包

- pandas: 数据处理和分析
- numpy: 数值计算
- scipy: 科学计算
- openpyxl: Excel文件操作
- PyQt5: 图形用户界面
- matplotlib: 数据可视化
- pyyaml: YAML文件操作
- pytest: 单元测试 